<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ§Øª</title>
  <link rel="icon" href="./logo2.jpg" type="image/jpeg">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #f97316;
      --primary-hover: #ea580c;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;
      --dark-light: #1e293b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), 
                  url('./images/backraound.jpg') center/cover fixed;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      direction: rtl;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 460px;
      padding: 45px 40px;
      background: rgba(30, 41, 59, 0.95);
      border-radius: 20px;
      backdrop-filter: blur(20px);
      border: 2px solid rgba(249, 115, 22, 0.3);
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo-container {
      margin-bottom: 25px;
    }

    .logo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid var(--primary);
      box-shadow: 0 8px 25px rgba(249, 115, 22, 0.4);
      object-fit: cover;
    }

    h2 {
      color: var(--primary);
      font-size: 1.8em;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .subtitle {
      color: #94a3b8;
      margin-bottom: 30px;
      font-size: 0.95em;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: right;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #cbd5e1;
      font-size: 0.9em;
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 16px 18px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
    }

    input:focus {
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    button {
      width: 100%;
      padding: 16px;
      margin: 10px 0;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(249, 115, 22, 0.6);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }

    .status {
      padding: 14px 18px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: 600;
      font-size: 0.95em;
      animation: fadeIn 0.3s ease;
      display: none;
    }

    .status.show {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status.success {
      background: rgba(16, 185, 129, 0.2);
      border: 2px solid var(--success);
      color: var(--success);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid var(--danger);
      color: var(--danger);
    }

    .status.info {
      background: rgba(59, 130, 246, 0.2);
      border: 2px solid #3b82f6;
      color: #3b82f6;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 25px 0;
      color: #64748b;
      font-size: 0.9em;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }

    .divider::before {
      margin-left: 15px;
    }

    .divider::after {
      margin-right: 15px;
    }

    .link {
      color: #fbbf24;
      text-decoration: none;
      margin-top: 15px;
      display: inline-block;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .link:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    .hidden {
      display: none !important;
    }

    .loader {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .password-toggle {
      position: relative;
    }

    .password-toggle input {
      padding-left: 50px;
    }

    .toggle-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #94a3b8;
      font-size: 1.2em;
      user-select: none;
      transition: color 0.3s;
    }

    .toggle-icon:hover {
      color: var(--primary);
    }

    @media (max-width: 480px) {
      .container {
        padding: 35px 25px;
      }

      h2 {
        font-size: 1.5em;
      }

      .logo {
        width: 100px;
        height: 100px;
      }
    }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen" class="container">
  <div class="logo-container">
    <img src="./logo2.jpg" alt="logo" class="logo">
  </div>
  <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ</h2>
  <p class="subtitle">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
  
  <form id="loginForm">
    <div class="form-group">
      <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="email" placeholder="example@domain.com" required autocomplete="email">
    </div>
    
    <div class="form-group password-toggle">
      <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password">
      <span class="toggle-icon" onclick="togglePassword('password')">ğŸ‘ï¸</span>
    </div>
    
    <button type="submit" class="btn-primary" id="loginBtn">
      <span id="loginBtnText">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
      <span id="loginBtnLoader" class="hidden"><span class="loader"></span></span>
    </button>
  </form>
  
  <div class="status" id="loginStatus"></div>
  
  <div class="divider">Ø£Ùˆ</div>
  
  <a href="#" class="link" id="toRegister">Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© â†</a>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
<div id="registerScreen" class="container hidden">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
  <p class="subtitle">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØªÙƒ</p>
  
  <div class="form-group">
    <label for="academyName">Ø§Ø³Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© *</label>
    <input type="text" id="academyName" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©" required>
  </div>
  
  <div class="form-group">
    <label for="fullName">Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
    <input type="text" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
  </div>
  
  <div class="form-group">
    <label for="regEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
    <input type="email" id="regEmail" placeholder="admin@academy.com" required autocomplete="email">
  </div>
  
  <div class="form-group password-toggle">
    <label for="regPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± * (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
    <input type="password" id="regPassword" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©" minlength="6" required autocomplete="new-password">
    <span class="toggle-icon" onclick="togglePassword('regPassword')">ğŸ‘ï¸</span>
  </div>
  
  <button type="button" class="btn-primary" id="createBtn">
    <span id="createBtnText">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</span>
    <span id="createBtnLoader" class="hidden"><span class="loader"></span></span>
  </button>
  
  <div class="status" id="regStatus"></div>
  
  <div class="divider">Ø£Ùˆ</div>
  
  <a href="#" class="link" id="backToLogin">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
</div>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
  const SUPABASE_URL = 'https://nhzbnzcdsebepsmrtona.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oemJuemNkc2ViZXBzbXJ0b25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NjU4MTEsImV4cCI6MjA3OTI0MTgxMX0.wNSf49MpQjCCopByd3zCz4-TJ2EGGABc3-ICEsAPaFo'
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  function showStatus(elementId, message, type = 'info') {
    const el = document.getElementById(elementId)
    el.textContent = message
    el.className = `status ${type} show`
    
    if (type === 'success' || type === 'error') {
      setTimeout(() => {
        el.classList.remove('show')
      }, type === 'error' ? 6000 : 4000)
    }
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  function hideStatus(elementId) {
    const el = document.getElementById(elementId)
    el.classList.remove('show')
  }

  // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  function togglePassword(inputId) {
    const input = document.getElementById(inputId)
    input.type = input.type === 'password' ? 'text' : 'password'
  }
  window.togglePassword = togglePassword

  // ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
  document.getElementById('toRegister').onclick = (e) => {
    e.preventDefault()
    document.getElementById('loginScreen').classList.add('hidden')
    document.getElementById('registerScreen').classList.remove('hidden')
    hideStatus('loginStatus')
  }

  document.getElementById('backToLogin').onclick = (e) => {
    e.preventDefault()
    document.getElementById('registerScreen').classList.add('hidden')
    document.getElementById('loginScreen').classList.remove('hidden')
    hideStatus('regStatus')
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault()
    
    const email = document.getElementById('email').value.trim()
    const password = document.getElementById('password').value
    const loginBtn = document.getElementById('loginBtn')
    
    if (!email || !password) {
      showStatus('loginStatus', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error')
      return
    }

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    loginBtn.disabled = true
    document.getElementById('loginBtnText').classList.add('hidden')
    document.getElementById('loginBtnLoader').classList.remove('hidden')
    showStatus('loginStatus', 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', 'info')

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      })

      if (error) {
        let errorMsg = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'
        
        if (error.message.includes('Invalid login credentials')) {
          errorMsg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'
        } else if (error.message.includes('Email not confirmed')) {
          errorMsg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
        } else if (error.message.includes('Invalid email')) {
          errorMsg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­'
        }
        
        showStatus('loginStatus', errorMsg, 'error')
        return
      }

      if (!data.user) {
        showStatus('loginStatus', 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error')
        return
      }

      showStatus('loginStatus', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...', 'success')
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡
      await checkUserRoleAndRedirect(data.user)

    } catch (err) {
      console.error('Ø®Ø·Ø£:', err)
      showStatus('loginStatus', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error')
    } finally {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
      loginBtn.disabled = false
      document.getElementById('loginBtnText').classList.remove('hidden')
      document.getElementById('loginBtnLoader').classList.add('hidden')
    }
  }

  // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡
  async function checkUserRoleAndRedirect(user) {
    try {
      console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.id)
      
      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ø¯ÙˆÙ„ academy_members Ù…Ø¹ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø£ÙƒØ«Ø± Ù…Ø±ÙˆÙ†Ø©
      const { data: memberships, error: memberError } = await supabase
        .from('academy_members')
        .select('academy_id, role, user_id')
        .eq('user_id', user.id)

      console.log('ğŸ“‹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª:', memberships)
      console.log('âš ï¸ Ø®Ø·Ø£ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:', memberError)

      if (memberError && memberError.code !== 'PGRST116') {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…:', memberError)
      }

      // Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯ Ø§Ù„Ø¹Ø¶Ùˆ ÙÙŠ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©
      if (memberships && memberships.length > 0) {
        const member = memberships[0]
        
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:', member)
        
        // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
        const { data: academy, error: acadError } = await supabase
          .from('academies')
          .select('id, name, slug')
          .eq('id', member.academy_id)
          .single()

        console.log('ğŸ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©:', academy)

        if (acadError) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©:', acadError)
        }

        const academyName = academy?.name || 'Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'
        const academySlug = academy?.slug || ''
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        localStorage.setItem('user_id', user.id)
        localStorage.setItem('user_email', user.email)
        localStorage.setItem('user_role', member.role.toLowerCase())
        localStorage.setItem('current_academy_id', member.academy_id)
        localStorage.setItem('current_academy_name', academyName)
        
        if (academySlug) {
          localStorage.setItem('current_academy_slug', academySlug)
        }

        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', {
          role: member.role,
          academy_id: member.academy_id,
          academy_name: academyName
        })

        // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± (Ù…Ø¹ Ø¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª)
        const role = member.role.toLowerCase().trim()
        const redirectMap = {
          'admin': 'admin-dashboard.html',
          'owner': 'admin-dashboard.html',
          'teacher': 'dashboard-teacher.html',
          'secretary': 'dashboard-secretary.html',
          'student': 'student-dashboard.html'
        }

        const redirectPage = redirectMap[role]
        
        console.log('ğŸ¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰:', redirectPage, 'Ù„Ù„Ø¯ÙˆØ±:', role)
        
        if (redirectPage) {
          showStatus('loginStatus', 
            `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙƒÙ€ ${role}! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...`, 
            'success'
          )
          
          setTimeout(() => {
            window.location.href = redirectPage
          }, 1000)
          return
        } else {
          console.error('âš ï¸ Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ:', role)
          showStatus('loginStatus', 
            `Ø¯ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… (${member.role}) ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø­Ø§Ù„ÙŠØ§Ù‹. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…`, 
            'error'
          )
          return
        }
      }

      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ø¹Ø¶ÙˆÙŠØ© - Ø§Ù„Ø¨Ø­Ø« ÙÙŠ profiles
      console.log('ğŸ” Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ø¹Ø¶ÙˆÙŠØ©ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ profiles...')
      
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('id, email, role, full_name')
        .eq('id', user.id)
        .single()

      console.log('ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Profile:', profile)

      if (profile && profile.role) {
        console.log('âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ profiles Ù„ÙƒÙ† Ù„ÙŠØ³ ÙÙŠ academy_members')
        showStatus('loginStatus', 
          `Ø­Ø³Ø§Ø¨Ùƒ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØªÙƒ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…`, 
          'error'
        )
      } else {
        showStatus('loginStatus', 
          'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø£ÙŠ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØªÙƒ', 
          'error'
        )
      }
      
      // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ
      console.log('ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ...')
      await supabase.auth.signOut()
      
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', err)
      showStatus('loginStatus', 
        `Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ: ${err.message}`, 
        'error'
      )
    }
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
  document.getElementById('createBtn').onclick = async () => {
    const academyName = document.getElementById('academyName').value.trim()
    const fullName = document.getElementById('fullName').value.trim()
    const email = document.getElementById('regEmail').value.trim()
    const password = document.getElementById('regPassword').value
    const createBtn = document.getElementById('createBtn')

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!academyName || !fullName || !email || !password) {
      showStatus('regStatus', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error')
      return
    }

    if (password.length < 6) {
      showStatus('regStatus', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error')
      return
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(email)) {
      showStatus('regStatus', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­', 'error')
      return
    }

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    createBtn.disabled = true
    document.getElementById('createBtnText').classList.add('hidden')
    document.getElementById('createBtnLoader').classList.remove('hidden')
    showStatus('regStatus', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©...', 'info')

    try {
      // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: fullName
          }
        }
      })

      if (authError) {
        let errorMsg = 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'
        
        if (authError.message.includes('already registered')) {
          errorMsg = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙŠØ¯ Ø¢Ø®Ø± Ø£Ùˆ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„'
        } else if (authError.message.includes('Invalid email')) {
          errorMsg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­'
        } else if (authError.message.includes('Password')) {
          errorMsg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ù‚ÙˆÙ‰'
        }
        
        showStatus('regStatus', errorMsg, 'error')
        return
      }

      if (!authData.user) {
        showStatus('regStatus', 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error')
        return
      }

      const userId = authData.user.id

      // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©
      const slug = academyName
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-\u0600-\u06FF]/g, '')
        .substring(0, 50)

      const { data: academy, error: acadError } = await supabase
        .from('academies')
        .insert({
          name: academyName,
          slug: slug,
          owner_id: userId,
          created_at: new Date().toISOString()
        })
        .select()
        .single()

      if (acadError) {
        showStatus('regStatus', 
          'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… Ù…ÙƒØ±Ø±Ø§Ù‹', 
          'error'
        )
        return
      }

      // 3. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ€ profile
      await supabase.from('profiles').upsert({
        id: userId,
        email: email,
        full_name: fullName,
        role: 'admin'
      })

      // 4. Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙƒÙ€ admin
      const { error: memberError } = await supabase
        .from('academy_members')
        .insert({
          academy_id: academy.id,
          user_id: userId,
          role: 'admin'
        })

      if (memberError) {
        showStatus('regStatus', 
          'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù„ÙƒÙ† ÙØ´Ù„Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…', 
          'error'
        )
        return
      }

      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      localStorage.setItem('user_id', userId)
      localStorage.setItem('user_email', email)
      localStorage.setItem('user_role', 'admin')
      localStorage.setItem('current_academy_id', academy.id)
      localStorage.setItem('current_academy_name', academyName)
      localStorage.setItem('current_academy_slug', slug)

      showStatus('regStatus', 
        'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...', 
        'success'
      )

      // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
      setTimeout(() => {
        window.location.href = 'admin-dashboard.html'
      }, 2000)

    } catch (err) {
      console.error('Ø®Ø·Ø£:', err)
      showStatus('regStatus', 
        'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 
        'error'
      )
    } finally {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
      createBtn.disabled = false
      document.getElementById('createBtnText').classList.remove('hidden')
      document.getElementById('createBtnLoader').classList.add('hidden')
    }
  }
</script>
</body>
</html>