<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="var(--dark)" name="theme-color"/>
<title>تسجيل الدخول</title>
<!-- Manifest -->
<link href="manifest.json" rel="manifest"/>
<!-- Favicon -->
<link href="./logo2.jpg" rel="icon" type="image/jpeg"/>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
    --primary: #f97316;
    --primary-dark: #ea580c;
    --primary-light: #fed7aa;
    --secondary: #059669;
    --secondary-light: #d1fae5;
    --dark: #1f2937;
    --light: #f9fafb;
    --gray: #6b7280;
    --gray-light: #f3f4f6;
    --border: #e5e7eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --waiting: #8b5cf6;
    --sidebar-width: 280px;
    --header-height: 70px;
    --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-medium: 0 4px 6px rgba(0,0,0,0.15);
    --shadow-heavy: 0 10px 25px rgba(0,0,0,0.3);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 20px;
}

* {
  box-sizing: border-box;
  transition: all 0.3s ease;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  padding: 20px;
  background-image: 
    linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.55)), 
    url('./images/backraound.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  margin: 0;
  direction: rtl;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

.container {
  max-width: 420px;
  width: 100%;
  padding: 40px;
  border-radius: var(--radius-lg);
  background: rgba(255, 255, 255, 0.12);
  border: 1px solid rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: var(--shadow-heavy);
  color: #fff;
  animation: fadeInUp 0.8s ease both;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

h2 {
  text-align: center;
  color: #fff;
  margin-bottom: 25px;
  font-size: 26px;
  font-weight: 700;
  letter-spacing: 1px;
}

label {
  display: block;
  margin: 18px 0 8px;
  font-weight: 600;
  color: #f3f4f6;
  font-size: 14px;
}

.input-group {
  position: relative;
}

.input-group i {
  position: absolute;
  top: 50%;
  left: 14px;
  transform: translateY(-50%);
  color: rgba(255,255,255,0.7);
  pointer-events: none;
}

input {
  width: 100%;
  padding: 14px 40px 14px 14px;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: var(--radius-md);
  font-size: 15px;
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
}

input::placeholder {
  color: rgba(255,255,255,0.7);
}

input:focus {
  outline: none;
  border-color: var(--primary-light);
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3), 0 0 12px var(--primary-light);
}

button {
  margin-top: 28px;
  padding: 14px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: #fff;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  width: 100%;
  font-size: 16px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.4), 0 0 20px var(--primary-light);
}

button:active {
  transform: translateY(0);
}

#status, #regStatus, #resetStatus, #changeEmailStatus {
  margin-top: 20px;
  padding: 14px;
  border-radius: var(--radius-md);
  text-align: center;
  font-weight: bold;
  font-size: 14px;
}

.success { 
  background: linear-gradient(135deg, var(--success) 0%, var(--secondary-light) 100%); 
  color: white; 
}

.error { 
  background: linear-gradient(135deg, var(--danger) 0%, var(--danger) 100%); 
  color: white; 
}

.info { 
  background: linear-gradient(135deg, var(--info) 0%, var(--info) 100%); 
  color: white; 
}

.loader {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
  margin-left: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.register-link {
  text-align: center;
  margin-top: 20px;
  padding: 15px;
  background: rgba(255,255,255,0.08);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-light);
}

.register-link a {
  color: var(--primary-light);
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
  display: block;
  margin: 5px 0;
}

.register-link a:hover {
  color: #fff;
  text-decoration: underline;
}

.install-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 20px;
  background: var(--dark);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  z-index: 10000;
  box-shadow: var(--shadow-heavy);
}

@media (max-width: 500px) {
  .container {
    padding: 25px;
  }
  h2 {
    font-size: 22px;
  }
  input, button {
    font-size: 14px;
    padding: 12px;
  }
}
</style>
</head>
<body>
<div class="container">
<img alt="Logo" src="./logo2.jpg" style="display:block; margin:0 auto 15px;     width: 100px;
    height: 100px; border-radius:50%; box-shadow: var(--shadow-medium);"/><h2> تسجيل الدخول</h2>
<form id="loginForm">
<label>📧 البريد الإلكتروني:
        <input autocomplete="email" id="email" placeholder="أدخل بريدك الإلكتروني" required="" type="email"/>
</label>
<label>🔒 كلمة المرور:
        <input autocomplete="current-password" id="password" placeholder="أدخل كلمة المرور" required="" type="password"/>
</label>
<button type="submit">دخول</button>
</form>
<p id="status"></p>
<div class="register-link">
<a href="#" onclick="showRegisterForm()">إنشاء حساب جديد</a>
<a href="#" onclick="showResetPasswordForm()">نسيت كلمة المرور؟</a>
<a href="#" onclick="showChangeEmailForm()">تغيير البريد الإلكتروني</a>
</div>
</div>
<!-- نموذج التسجيل -->
<div id="registerContainer" style="display: none;">
<div class="container">
<h2>📝 تسجيل مستخدم جديد</h2>
<form id="registerForm">
<label>👤 الاسم الكامل:
          <input id="regFullName" placeholder="أدخل اسمك الكامل" required="" type="text"/>
</label>
<label>📧 البريد الإلكتروني:
          <input id="regEmail" placeholder="أدخل بريدك الإلكتروني" required="" type="email"/>
</label>
<label>🔒 كلمة المرور:
          <input id="regPassword" minlength="6" placeholder="أدخل كلمة مرور قوية" required="" type="password"/>
</label>
<label>👔 الدور:
          <select id="regRole" style="padding: 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--light);">
<option value="admin">مشرف</option>
<option value="teacher">معلم</option>
<option value="secretary">مسؤول الطلاب (السيكرتير)</option>
</select>
</label>
<button type="submit">تسجيل</button>
</form>
<p id="regStatus"></p>
<div class="register-link">
<a href="#" onclick="showLoginForm()">العودة لتسجيل الدخول</a>
</div>
</div>
</div>
<!-- نموذج إعادة تعيين كلمة المرور -->
<div id="resetPasswordContainer" style="display: none;">
<div class="container">
<h2>🔄 إعادة تعيين كلمة المرور</h2>
<form id="resetPasswordForm">
<label>📧 البريد الإلكتروني:
          <input id="resetEmail" placeholder="أدخل بريدك الإلكتروني" required="" type="email"/>
</label>
<button type="submit">إرسال رابط إعادة التعيين</button>
</form>
<p id="resetStatus"></p>
<div class="register-link">
<a href="#" onclick="showLoginForm()">العودة لتسجيل الدخول</a>
</div>
</div>
</div>
<!-- نموذج تغيير البريد الإلكتروني -->
<div id="changeEmailContainer" style="display: none;">
<div class="container">
<h2>✉️ تغيير البريد الإلكتروني</h2>
<div id="changeEmailFormContainer">
<form id="changeEmailForm">
<label>📧 البريد الإلكتروني الحالي:
            <input id="currentEmail" placeholder="أدخل بريدك الإلكتروني الحالي" readonly="" required="" type="email"/>
</label>
<label>📧 البريد الإلكتروني الجديد:
            <input id="newEmail" placeholder="أدخل البريد الإلكتروني الجديد" required="" type="email"/>
</label>
<button type="submit">إرسال رابط التأكيد</button>
</form>
</div>
<p id="changeEmailStatus"></p>
<div class="register-link">
<a href="#" onclick="showLoginForm()">العودة لتسجيل الدخول</a>
</div>
</div>
</div>
<script>
    // تهيئة العميل
    const supabaseClient = supabase.createClient(
      "https://zefsmckaihzfiqqbdake.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplZnNtY2thaWh6ZmlxcWJkYWtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMzUzNTgsImV4cCI6MjA2OTgxMTM1OH0.vktk2VkEPtMclb6jb_pFa1DbrqWX9SOZRsBR577o5mc"
    );

    // متغيرات للتخزين المؤقت في الذاكرة (بدلاً من localStorage)
    let currentUser = null;
    let signupEmail = null;

    // عرض نموذج التسجيل
    function showRegisterForm() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('registerContainer').style.display = 'block';
      document.getElementById('resetPasswordContainer').style.display = 'none';
      document.getElementById('changeEmailContainer').style.display = 'none';
    }

    // عرض نموذج إعادة تعيين كلمة المرور
    function showResetPasswordForm() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('registerContainer').style.display = 'none';
      document.getElementById('resetPasswordContainer').style.display = 'block';
      document.getElementById('changeEmailContainer').style.display = 'none';
    }

    // عرض نموذج تغيير البريد الإلكتروني
    function showChangeEmailForm() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('registerContainer').style.display = 'none';
      document.getElementById('resetPasswordContainer').style.display = 'none';
      document.getElementById('changeEmailContainer').style.display = 'block';
      
      // التحقق من حالة المستخدم وملء البريد الإلكتروني الحالي
      checkUserAndFillEmail();
    }

    // التحقق من حالة المستخدم وملء البريد الإلكتروني الحالي
    async function checkUserAndFillEmail() {
      try {
        // التحقق من حالة الجلسة أولاً
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          throw sessionError;
        }
        
        if (!session || !session.user) {
          document.getElementById('changeEmailFormContainer').style.display = 'none';
          document.getElementById('changeEmailStatus').className = 'error';
          document.getElementById('changeEmailStatus').textContent = '❌ يجب تسجيل الدخول أولاً لتغيير البريد الإلكتروني.';
          return;
        }

        // الحصول على بيانات المستخدم
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError) {
          throw userError;
        }
        
        if (user && user.email) {
          document.getElementById('currentEmail').value = user.email;
          document.getElementById('changeEmailFormContainer').style.display = 'block';
          document.getElementById('changeEmailStatus').className = 'info';
          document.getElementById('changeEmailStatus').textContent = '✅ تم العثور على حسابك. يمكنك الآن تغيير البريد الإلكتروني.';
        } else {
          document.getElementById('changeEmailFormContainer').style.display = 'none';
          document.getElementById('changeEmailStatus').className = 'error';
          document.getElementById('changeEmailStatus').textContent = '❌ يجب تسجيل الدخول أولاً لتغيير البريد الإلكتروني.';
        }
      } catch (error) {
        console.error('Error checking user:', error);
        document.getElementById('changeEmailFormContainer').style.display = 'none';
        document.getElementById('changeEmailStatus').className = 'error';
        document.getElementById('changeEmailStatus').textContent = '❌ خطأ في التحقق من الحساب: ' + error.message;
      }
    }

    // عرض نموذج تسجيل الدخول
    function showLoginForm() {
      document.getElementById('registerContainer').style.display = 'none';
      document.getElementById('resetPasswordContainer').style.display = 'none';
      document.getElementById('changeEmailContainer').style.display = 'none';
      document.querySelector('.container').style.display = 'block';
    }

    // معالج تسجيل الدخول
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const status = document.getElementById('status');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      status.textContent = '';
      status.className = 'info';
      status.innerHTML = '<span class="loader"></span> جاري تسجيل الدخول...';

      try {
        // تسجيل الدخول
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          status.className = 'error';
          status.textContent = 'فشل في الدخول: ' + error.message;
          return;
        }

        if (!data.user) {
          status.className = 'error';
          status.textContent = 'لم يتم استلام بيانات المستخدم.';
          return;
        }

        // محاولة جلب البيانات من user_metadata أولاً
        let full_name = data.user.user_metadata?.full_name;
        let role = data.user.user_metadata?.role;

        // إذا لم توجد البيانات في user_metadata، نحاول جلبها من جدول users
        if (!full_name || !role) {
          console.log('محاولة جلب البيانات من جدول users...');
          const { data: userData, error: userError } = await supabaseClient
            .from('users')
            .select('full_name, role')
            .eq('id', data.user.id)
            .maybeSingle();

          if (userError) {
            console.error('Database error:', userError);
            status.className = 'error';
            status.textContent = 'خطأ في قاعدة البيانات: ' + userError.message;
            return;
          }

          if (userData) {
            full_name = userData.full_name;
            role = userData.role;
          }
        }

        // التحقق من وجود البيانات المطلوبة
        if (!full_name || !role) {
          status.className = 'error';
          status.textContent = 'لم يتم العثور على بيانات المستخدم الكاملة. الاسم: ' + (full_name || 'غير محدد') + '، الدور: ' + (role || 'غير محدد');
          return;
        }
        currentUser = { ...data.user, full_name, role };

        status.className = 'success';

        if (role === 'admin') {
          status.textContent = `🎉 مرحباً ${full_name}! تحويل إلى لوحة المشرف...`;
          setTimeout(() => {
            alert('سيتم توجيهك إلى لوحة المشرف');
            window.location.href = 'admin-dashboard.html';
          }, 1500);
        } else if (role === 'teacher') {
          status.textContent = `🎉 مرحباً ${full_name}! تحويل إلى لوحة المعلم...`;
          setTimeout(() => {
            alert('سيتم توجيهك إلى لوحة المعلم');
            window.location.href = 'dashboard-teacher.html';
          }, 1500);
        } else if (role === 'secretary') {
          status.textContent = `🎉 مرحباً ${full_name}! تحويل إلى لوحة مسؤول الطلاب...`;
          setTimeout(() => {
            window.location.href = 'dashboard-secretary.html';
          }, 1500);
        } else {
          status.className = 'error';
          status.textContent = 'دور غير مشهور: ' + role;
        }

      } catch (err) {
        console.error('Unexpected error:', err);
        status.className = 'error';
        status.textContent = 'خطأ غير متوقع: ' + err.message;
      }
    });

// check if user came from supabase auth link
window.addEventListener("load", () => {
  const params = new URLSearchParams(window.location.hash.substring(1));
  if (params.has("access_token")) {
    // ✅ إعادة التوجيه للصفحة الرئيسية للمشروع
    window.location.href = "https://apdla-coder.github.io/Assiut-Academy/?" + window.location.hash.substring(1);
  }
});


// معالج التسجيل الجديد
document.getElementById('registerForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const status = document.getElementById('regStatus');
  status.textContent = '';
  status.className = '';

  const fullName = document.getElementById('regFullName').value;
  const email = document.getElementById('regEmail').value;
  const password = document.getElementById('regPassword').value;
  const role = document.getElementById('regRole').value;

  status.className = 'info';
  status.innerHTML = '<span class="loader"></span> جاري إنشاء الحساب...';

  try {
    // ✅ تحقق من الحد الأقصى للمستخدمين (6)
    const { count, error: countError } = await supabaseClient
      .from('users')
      .select('id', { count: 'exact', head: true });

    if (countError) {
      status.textContent = '❌ خطأ أثناء التحقق من عدد المستخدمين: ' + countError.message;
      status.className = 'error';
      return;
    }

    if (count >= 6) {
      status.textContent = '🚫 تم الوصول إلى الحد الأقصى (6 مستخدمين). برجاء التواصل مع المشرف لإضافة مستخدم جديد.';
      status.className = 'error';
      return;
    }

    // ✅ تحقق من البريد لو موجود قبل كده
    const { data: existingUser, error: checkError } = await supabaseClient
      .from('users')
      .select('email')
      .eq('email', email)
      .maybeSingle();

    if (checkError) {
      status.textContent = 'خطأ في التحقق من البريد الإلكتروني: ' + checkError.message;
      status.className = 'error';
      return;
    }

    if (existingUser) {
      status.textContent = '❌ هذا البريد الإلكتروني مسجل مسبقاً.';
      status.className = 'error';
      return;
    }

// إنشاء الحساب
const { data, error } = await supabaseClient.auth.signUp({
  email,
  password,
  options: {
    emailRedirectTo: 'https://apdla-coder.github.io/Assiut-Academy/',
    data: {
      full_name: fullName,
      role: role
    }
  }
});


    if (error) {
      console.error("خطأ في التسجيل:", error.message);
      status.className = 'error';
      status.textContent = 'خطأ في التسجيل: ' + error.message;
      return;
    }

    console.log("تم إنشاء المستخدم:", data.user);

    if (data && data.user) {
      status.textContent = '✅ تم إنشاء الحساب بنجاح! يرجى تفعيل حسابك من خلال الرابط المرسل إلى بريدك الإلكتروني.';
      status.className = 'success';
      setTimeout(() => {
        showLoginForm();
      }, 3000);
    } else {
      status.textContent = '📬 تم إرسال رابط التفعيل إلى بريدك.';
      status.className = 'success';
      setTimeout(() => {
        showLoginForm();
      }, 2000);
    }

  } catch (err) {
    status.textContent = '❌ خطأ غير متوقع: ' + err.message;
    status.className = 'error';
    console.error("Unexpected error:", err);
  }
});


    // معالج إعادة تعيين كلمة المرور
    document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const status = document.getElementById('resetStatus');
      const email = document.getElementById('resetEmail').value;

      status.textContent = '';
      status.className = 'info';
      status.innerHTML = '<span class="loader"></span> جاري إرسال الرابط...';

      try {
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://apdla-coder.github.io/Assiut-Academy/update-password.html'
        });

        if (error) throw error;

        status.className = 'success';
        status.textContent = '📬 تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني.';
      } catch (err) {
        status.className = 'error';
        status.textContent = '❌ حدث خطأ: ' + err.message;
      }
    });

    // معالج تغيير البريد الإلكتروني
    document.getElementById('changeEmailForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const status = document.getElementById('changeEmailStatus');
      const currentEmail = document.getElementById('currentEmail').value;
      const newEmail = document.getElementById('newEmail').value;

      // التحقق من أن البريد الإلكتروني الجديد مختلف عن الحالي
      if (currentEmail === newEmail) {
        status.className = 'error';
        status.textContent = '❌ البريد الإلكتروني الجديد يجب أن يكون مختلفًا عن الحالي';
        return;
      }

      status.textContent = '';
      status.className = 'info';
      status.innerHTML = '<span class="loader"></span> جاري إرسال رابط التأكيد...';

      try {
        // التحقق من أن المستخدم مسجل دخول
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          throw sessionError;
        }
        
        if (!session || !session.user) {
          status.className = 'error';
          status.textContent = '❌ يجب تسجيل الدخول أولاً';
          return;
        }

        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (userError) {
          throw userError;
        }
        
        if (!user) {
          status.className = 'error';
          status.textContent = '❌ يجب تسجيل الدخول أولاً';
          return;
        }

        // التحقق من أن البريد الإلكتروني الحالي صحيح
        if (user.email !== currentEmail) {
          status.className = 'error';
          status.textContent = '❌ هناك مشكلة في التحقق من البريد الإلكتروني الحالي';
          return;
        }

        // إرسال رابط تأكيد البريد الإلكتروني الجديد
        const { error } = await supabaseClient.auth.updateUser({ email: newEmail });

        if (error) throw error;

        status.className = 'success';
        status.textContent = '📬 تم إرسال رابط تأكيد البريد الإلكتروني الجديد إلى العنوان الجديد. يرجى التحقق من بريدك والضغط على الرابط للتأكيد.';

        // إعادة تعيين النموذج بعد نجاح العملية
        setTimeout(() => {
          document.getElementById('newEmail').value = '';
        }, 3000);

      } catch (err) {
        status.className = 'error';
        status.textContent = '❌ حدث خطأ: ' + err.message;
      }
    });

    // فحص حالة المصادقة عند تحميل الصفحة
    window.addEventListener('load', async () => {
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (session && !error) {
          console.log('المستخدم مسجل دخول مسبقاً:', session.user);
          currentUser = session.user;
        }
      } catch (err) {
        console.error('Error checking session:', err);
      }
    });
  </script>
<!-- تسجيل Service Worker + زر التثبيت -->
<script>
    // سجل SW مرة واحدة (الملف: sw.js)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('✅ Service Worker Registered', reg.scope))
        .catch(err => console.error('❌ Service Worker Error:', err));
    }

    // قبل حدث التثبيت: اعرض زر التثبيت للمستخدم
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;

      const installBtn = document.createElement('button');
      installBtn.className = 'install-btn';
      installBtn.textContent = '📲 تثبيت التطبيق';
      document.body.appendChild(installBtn);

      installBtn.addEventListener('click', async () => {
        installBtn.disabled = true;
        deferredPrompt.prompt();
        const choiceResult = await deferredPrompt.userChoice;
        if (choiceResult.outcome === 'accepted') {
          console.log('تم التثبيت بنجاح');
        } else {
          console.log('تم إلغاء التثبيت');
        }
        deferredPrompt = null;
        installBtn.remove();
      });
    });

    // optional: تحكّم في حدث التثبيت الفعلي (بعد التثبيت)
    window.addEventListener('appinstalled', () => {
      console.log('App installed');
    });

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // إظهار زر أو رسالة للمستخدم
      const installBtn = document.createElement('button');
      installBtn.innerText = '📲 ثبّت التطبيق';
      installBtn.style.position = 'fixed';
      installBtn.style.bottom = '20px';
      installBtn.style.right = '20px';
      installBtn.style.padding = '10px 20px';
      installBtn.style.zIndex = '9999';
      
      document.body.appendChild(installBtn);
      
      installBtn.addEventListener('click', async () => {
        installBtn.remove();
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to install: ${outcome}`);
        deferredPrompt = null;
      });
    });

    // استماع لرسائل من الـ Service Worker
    navigator.serviceWorker.addEventListener('message', (evt) => {
      const msg = evt.data;
      if (!msg) return;

      if (msg.type === 'SW_UPDATED') {
        // هنا تعرض للمستخدم نافذة/توست تخبره أن هناك تحديث
        // مثال بسيط: انشئ زر فورّي لإعادة تحميل الصفحة وتفعيل النسخة الجديدة
        const updateBar = document.createElement('div');
        updateBar.style.position = 'fixed';
        updateBar.style.left = '0';
        updateBar.style.right = '0';
        updateBar.style.bottom = '0';
        updateBar.style.padding = '12px';
        updateBar.style.background = 'var(--dark)';
        updateBar.style.color = '#fff';
        updateBar.style.textAlign = 'center';
        updateBar.style.zIndex = '10000';
        updateBar.textContent = 'يوجد تحديث متاح — اضغط للتحديث الآن';
        updateBar.style.cursor = 'pointer';
        document.body.appendChild(updateBar);

        updateBar.addEventListener('click', async () => {
          // اطلب من الـ SW تفعيل نفسه فوراً، ثم أعد تحميل الصفحة
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration && registration.waiting) {
            // أخبر الـ SW الانتظار أنه يرغب في التفعيل فوراً
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
          // انتظر قليلاً ثم أعد تحميل الصفحة لتستخدم النسخة الجديدة
          setTimeout(() => location.reload(true), 500);
        });

        // اختفاء الزر بعد 20 ثانية تلقائياً
        setTimeout(() => {
          updateBar.remove();
        }, 20000);
      }
    });
  </script>
</body>
</html>